# ===============================================================
# Manufacturing Orchestrator Agent - Solace Agent Mesh Config
# ===============================================================

log:
  stdout_log_level: INFO
  log_file_level: INFO
  log_file: orchestrator-agent.log

# Shared SAM base config
!include ../shared_config.yaml

apps:
  - name: manufacturing-orchestrator-app
    app_base_path: .
    app_module: solace_agent_mesh.agent.sac.app

    broker:
      <<: *broker_connection

    app_config:
      namespace: ${NAMESPACE}
      supports_streaming: true

      agent_name: "ManufacturingOrchestrator"
      display_name: "ManufacturingOrchestrator"

      # Preferred LLM for orchestration
      model: *planning_model

      # ===========================================================
      #  MANUFACTURING-SPECIFIC ORCHESTRATOR INSTRUCTIONS
      # ===========================================================
      instruction: |
        You are the **Manufacturing Orchestrator Agent**.

        Your role: Coordinate forecasting and scheduling workflows by delegating to specialized agents.

        ======================================================================
        AVAILABLE TOOLS
        ======================================================================

        You have access to these tools for inter-agent communication:
        - **PeerAgentTool**: Use this to delegate tasks to other agents

        ======================================================================
        AVAILABLE AGENTS
        ======================================================================

        - **DemandForecastingAgent**: Forecasts demand from CSV data
        - **DynamicSchedulingAgent**: Generates production schedules

        ======================================================================
        WORKFLOW LOGIC
        ======================================================================

        **For: "Generate schedule for [date] with CSV [url]"**

        Step 1: Call DemandForecastingAgent ONCE
          - Use PeerAgentTool to delegate
          - Provide: CSV URL and target date
          - Wait for forecast result
        
        Step 2: After receiving forecast, call DynamicSchedulingAgent ONCE
          - Use PeerAgentTool to delegate
          - Provide: date and predicted demand from forecast
          - Wait for schedule result
        
        Step 3: Present schedule to user
          - Show the final schedule
          - Workflow complete

        ======================================================================
        CRITICAL RULES
        ======================================================================

        1. **Call each agent only ONCE per workflow**
           - After DemandForecastingAgent responds → call DynamicSchedulingAgent
           - Do NOT call DemandForecastingAgent again

        2. **Use PeerAgentTool to actually invoke agents**
           - Don't just describe what you would call
           - Actually execute the tool

        3. **Track workflow state mentally**
           - Remember what you've already called
           - Don't repeat agent calls

        4. **Recognize agent responses**
           - When you receive forecast data → that's a response, not a new request
           - Extract the demand value and move to scheduling

        ======================================================================
        SIMPLIFIED EXAMPLE
        ======================================================================

        User: "Generate schedule for 2025-11-24 with CSV: https://example.com/data.csv"

        You:
        → "Forecasting demand for 2025-11-24..."
        → [Use PeerAgentTool for DemandForecastingAgent]
        → [Wait]

        [Forecast returns: 1500 units]

        You:
        → "Forecast: 1500 units. Generating schedule..."
        → [Use PeerAgentTool for DynamicSchedulingAgent with demand=1500]
        → [DO NOT call forecaster again]
        → [Wait]

        [Schedule returns]

        You:
        → Present schedule to user
        → Done


      inject_system_purpose: true
      inject_response_format: true
      inject_user_profile: true

      # ===========================================================
      # PERSISTENCE LAYERS & SERVICES
      # ===========================================================
      session_service:
        type: "sql"
        database_url: "${ORCHESTRATOR_DATABASE_URL, sqlite:///orchestrator.db}"
        default_behavior: "PERSISTENT"

      artifact_service: *default_artifact_service
      artifact_handling_mode: "reference"
      enable_embed_resolution: true
      enable_artifact_content_instruction: true
      data_tools_config: *default_data_tools_config

      # ===========================================================
      # BUILT-IN TOOLS (artifact + data ops)
      # ===========================================================
      tools:
        - group_name: artifact_management
          tool_type: builtin-group
        - group_name: data_analysis
          tool_type: builtin-group

      # ===========================================================
      # ORCHESTRATOR CAPABILITIES / AGENT CARD
      # ===========================================================
      agent_card:
        description: "The central orchestrator for the manufacturing agent network. Manages domain-specific workflows and coordinates all manufacturing agents."

        defaultInputModes: [text]
        defaultOutputModes: [text, file]

        skills:
          - id: manufacturing_planning
            name: Manufacturing Planning
            description: Understands and coordinates manufacturing workflows including forecasting, capacity planning, scheduling, inventory control, and logistics.

          - id: agent_coordination
            name: Manufacturing Agent Coordination
            description: Chooses and sequences specialized agents to complete tasks like demand forecasting, production scheduling, inventory optimization, etc.

          - id: strategic_workflow_execution
            name: Strategic Workflow Execution
            description: Builds multi-step execution plans for manufacturing pipelines and manages data handoffs between agents.

          - id: artifact_management
            name: Manufacturing Artifact Management
            description: Manages production schedules, demand forecasts, BOMs, SKU datasets, and planning artifacts.

      agent_card_publishing:
        interval_seconds: 10

      agent_discovery:
        enabled: true

      inter_agent_communication:
        allow_list: ["*"]
        request_timeout_seconds: 600
